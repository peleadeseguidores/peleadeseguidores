const SHEET_NAME = "Jugadores";
const FOLDER_NAME = "FotosJugadores";

function getSheet() {
  return SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_NAME);
}

function getFolder() {
  const folders = DriveApp.getFoldersByName(FOLDER_NAME);
  if (folders.hasNext()) return folders.next();
  return DriveApp.createFolder(FOLDER_NAME);
}

// GET: Lista de jugadores
function doGet() {
  const sheet = getSheet();
  const data = sheet.getDataRange().getValues();
  const jugadores = [];

  for (let i = 1; i < data.length; i++) {
    const [nombre, url_foto, fecha] = data[i];
    if (nombre && url_foto) {
      jugadores.push({ nombre, url_foto, fecha });
    }
  }

  const output = ContentService.createTextOutput(JSON.stringify({ total: jugadores.length, jugadores }));
  output.setMimeType(ContentService.MimeType.JSON);
  return output;
}

// POST: Recibe nombre + foto base64
function doPost(e) {
  try {
    const nombre = e.parameter.nombre;
    const base64 = e.parameter.foto;
    const mimeType = e.parameter.mimetype || "image/png";
    const filename = e.parameter.filename || "foto.png";

    if (!nombre || !base64) {
      return ContentService.createTextOutput(JSON.stringify({ status: "error", message: "Faltan parÃ¡metros" }))
                           .setMimeType(ContentService.MimeType.JSON);
    }

    const bytes = Utilities.base64Decode(base64);
    const blob = Utilities.newBlob(bytes, mimeType, filename);

    const folder = getFolder();
    const file = folder.createFile(blob);
    file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
    // URL directa para mostrar imagen en <img>:
    const url_foto = "https://drive.google.com/uc?export=view&id=" + file.getId();

    const sheet = getSheet();
    sheet.appendRow([nombre, url_foto, new Date()]);

    return ContentService.createTextOutput(JSON.stringify({ status: "success", url_foto }))
                         .setMimeType(ContentService.MimeType.JSON);
  } catch (err) {
    return ContentService.createTextOutput(JSON.stringify({ status: "error", message: err.message }))
                         .setMimeType(ContentService.MimeType.JSON);
  }
}
