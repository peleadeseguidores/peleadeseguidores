<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Registro de Jugadores</title>
  <style>
    :root{--bg:#f5f6fb;--card:#ffffff;--text:#1f2937;--muted:#6b7280;--ok:#22c55e;--ok-dark:#16a34a;--border:#e5e7eb;}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    .wrap{max-width:980px;margin:36px auto;padding:0 16px}
    h1{font-size:32px;margin:0 0 8px;color:var(--text);text-align:center}
    .counter{color:var(--muted);text-align:center;margin-bottom:22px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:0 4px 24px rgba(0,0,0,.04);padding:16px;margin-bottom:28px}
    form{display:grid;gap:12px;max-width:560px;margin:0 auto}
    input[type="text"]{width:100%;height:44px;padding:0 12px;border:1px solid var(--border);border-radius:10px;font-size:16px}
    input[type="file"]{font-size:14px}
    button{height:46px;border:0;background:var(--ok);color:#fff;border-radius:10px;font-weight:600;font-size:16px;cursor:pointer}
    button:disabled{opacity:.7;cursor:not-allowed}
    .msg{min-height:20px;font-size:14px;text-align:center}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:14px}
    .player{background:#fff;border:1px solid var(--border);border-radius:12px;overflow:hidden}
    .player img{width:100%;aspect-ratio:1/1;object-fit:cover;display:block}
    .player .pbody{padding:10px}
    .name{font-weight:600;color:var(--text)}
    .small{color:var(--muted);font-size:12px;margin-top:2px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Registro de Jugadores</h1>
    <div class="counter">Total de jugadores: <span id="total">0</span></div>

    <div class="card">
      <form id="form">
        <input id="nombre" type="text" placeholder="Usuario de Instagram (ej: @tuusuario)" required />
        <input id="foto" type="file" accept="image/*" required />
        <button id="btn" type="submit">Registrar</button>
        <div id="msg" class="msg"></div>
      </form>
    </div>

    <div class="card">
      <div class="grid" id="lista"></div>
    </div>
  </div>

  <script>
    // ⬇️ TU Apps Script Web App
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzOUrfegnhNU88vO9ANtu9H__keDqWjDHAQlgMLMWELCydzQ6qi9010fKf55Zi3yn3G/exec";

    const $ = (q) => document.querySelector(q);
    const totalEl = $("#total");
    const listaEl = $("#lista");
    const form = $("#form");
    const btn = $("#btn");
    const msg = $("#msg");

    async function toBase64(file) {
      return new Promise((resolve, reject) => {
        const r = new FileReader();
        r.onload = () => {
          const result = r.result; // data:*/*;base64,XXXX
          const [prefix, b64] = String(result).split(",");
          const mime = prefix.substring(prefix.indexOf(":") + 1, prefix.indexOf(";"));
          resolve({ base64: b64, mime });
        };
        r.onerror = () => reject(r.error);
        r.readAsDataURL(file);
      });
    }

    async function loadJugadores() {
      try {
        const res = await fetch(WEB_APP_URL, { method: "GET" });
        const data = await res.json();
        totalEl.textContent = data.total ?? 0;
        renderLista(data.jugadores || []);
      } catch (e) {
        msg.textContent = "No se pudo cargar la lista.";
        console.error(e);
      }
    }

    function renderLista(items) {
      if (!items.length) {
        listaEl.innerHTML = `<div class="small" style="grid-column:1/-1;text-align:center">Aún no hay jugadores registrados.</div>`;
        return;
      }
      listaEl.innerHTML = items
        .map(j => `
          <div class="player">
            <img src="${j.foto}" alt="${j.nombre}" loading="lazy">
            <div class="pbody">
              <div class="name">${escapeHtml(j.nombre)}</div>
              <div class="small">${j.fecha ? new Date(j.fecha).toLocaleString() : ""}</div>
            </div>
          </div>
        `).join("");
    }

    function escapeHtml(s){return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]))}

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      msg.textContent = "";
      const nombre = $("#nombre").value.trim();
      const file = $("#foto").files[0];

      if (!nombre || !file) { msg.textContent = "Completa nombre y foto."; return; }
      if (file.size > 8 * 1024 * 1024) { msg.textContent = "La imagen debe pesar menos de 8 MB."; return; }

      btn.disabled = true; btn.textContent = "Enviando…";

      try {
        const { base64, mime } = await toBase64(file);

        // doPost(e) espera e.parameter => enviamos como x-www-form-urlencoded
        const body = new URLSearchParams({
          nombre: nombre,
          foto: base64,
          mimetype: mime,
          filename: file.name
        });

        const res = await fetch(WEB_APP_URL, {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
          body
        });

        const out = await res.json();
        if (out.status === "success") {
          msg.style.color = "var(--ok-dark)";
          msg.textContent = "Jugador registrado con éxito.";
          form.reset();
          await loadJugadores();
        } else {
          throw new Error(out.message || "Error desconocido");
        }
      } catch (err) {
        console.error(err);
        msg.style.color = "#b91c1c";
        msg.textContent = "Error al registrar: " + err.message;
      } finally {
        btn.disabled = false; btn.textContent = "Registrar";
      }
    });

    // Carga inicial
    loadJugadores();
  </script>
</body>
</html>



