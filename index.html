<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Registro de Jugadores</title>
<style>
  :root{--bg:#f5f6fb;--card:#fff;--text:#1f2937;--muted:#6b7280;--ok:#22c55e;--ok-dark:#16a34a;--border:#e5e7eb;}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;background:var(--bg)}
  .wrap{max-width:980px;margin:36px auto;padding:0 16px}
  h1{text-align:center;color:var(--text)}
  .counter{text-align:center;color:var(--muted);margin-bottom:22px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;margin-bottom:28px}
  form{display:grid;gap:12px;max-width:560px;margin:0 auto}
  input[type=text], input[type=file]{width:100%;padding:0 12px;height:44px;border:1px solid var(--border);border-radius:10px;font-size:16px}
  button{height:46px;border:0;background:var(--ok);color:#fff;border-radius:10px;font-weight:600;font-size:16px;cursor:pointer}
  button:disabled{opacity:.7;cursor:not-allowed}
  .msg{min-height:20px;font-size:14px;text-align:center}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:14px}
  .player{background:#fff;border:1px solid var(--border);border-radius:12px;overflow:hidden}
  .player img{width:100%;aspect-ratio:1/1;object-fit:cover;display:block}
  .pbody{padding:10px}
  .name{font-weight:600;color:var(--text)}
  .small{color:var(--muted);font-size:12px;margin-top:2px}
</style>
</head>
<body>
<div class="wrap">
  <h1>Registro de Jugadores</h1>
  <div class="counter">Total de jugadores: <span id="total">0</span></div>

  <div class="card">
    <form id="form">
      <input id="nombre" type="text" placeholder="Usuario de Instagram (ej: @usuario)" required />
      <input id="foto" type="file" accept="image/*" required />
      <button id="btn" type="submit">Registrar</button>
      <div id="msg" class="msg"></div>
    </form>
  </div>

  <div class="card">
    <div class="grid" id="lista"></div>
  </div>
</div>

<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxL-WFJeCZ6NHDAEPW6-Qq9xwjmZyJsNIn2XCmA7jU3A4hHyH_mwPeFIePMeyhLGOEI/exec";
const totalEl = document.querySelector("#total");
const listaEl = document.querySelector("#lista");
const form = document.querySelector("#form");
const btn = document.querySelector("#btn");
const msg = document.querySelector("#msg");

async function toBase64(file){
  return new Promise((resolve,reject)=>{
    const r=new FileReader();
    r.onload=()=>{const [prefix,b64]=r.result.split(",");resolve({base64:b64,mime:prefix.split(":")[1].split(";")[0]})};
    r.onerror=()=>reject(r.error);
    r.readAsDataURL(file);
  });
}

async function loadJugadores(){
  try{
    const res=await fetch(WEB_APP_URL);
    const data=await res.json();
    totalEl.textContent=data.total??0;
    renderLista(data.jugadores||[]);
  }catch(e){msg.textContent="No se pudo cargar la lista.";console.error(e);}
}

function renderLista(items){
  if(!items.length){
    listaEl.innerHTML=`<div class="small" style="grid-column:1/-1;text-align:center">Aún no hay jugadores registrados.</div>`;
    return;
  }
  listaEl.innerHTML=items.map(j=>`
    <div class="player">
      <img src="${j.foto}" alt="${j.nombre}" loading="lazy">
      <div class="pbody">
        <div class="name">${escapeHtml(j.nombre)}</div>
        <div class="small">${j.fecha?new Date(j.fecha).toLocaleString():""}</div>
      </div>
    </div>
  `).join("");
}

function escapeHtml(s){return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));}

form.addEventListener("submit", async (e)=>{
  e.preventDefault(); msg.textContent=""; 
  const nombre=document.querySelector("#nombre").value.trim();
  const file=document.querySelector("#foto").files[0];
  if(!nombre||!file){msg.textContent="Completa nombre y foto.";return;}
  if(file.size>8*1024*1024){msg.textContent="La imagen debe pesar menos de 8 MB.";return;}
  btn.disabled=true; btn.textContent="Enviando…";
  try{
    const {base64,mime}=await toBase64(file);
    const body=new URLSearchParams({nombre,foto:base64,mimetype:mime,filename:file.name});
    const res=await fetch(WEB_APP_URL,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"},body});
    const out=await res.json();
    if(out.status==="success"){msg.style.color="#16a34a";msg.textContent="Jugador registrado con éxito.";form.reset();await loadJugadores();}
    else throw new Error(out.message||"Error desconocido");
  }catch(err){console.error(err);msg.style.color="#b91c1c";msg.textContent="Error al registrar: "+err.message;}
  finally{btn.disabled=false;btn.textContent="Registrar";}
});

loadJugadores();
</script>
</body>
</html>
