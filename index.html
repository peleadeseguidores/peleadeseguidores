<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <title>@PELEA DE SEGUIDORES</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
<div class="wrap">
  <div class="title-bar">
    <!-- SVG Espada Izquierda -->
    <svg class="sword left" viewBox="0 0 64 64">
      <g>
        <rect x="29" y="6" width="6" height="38" rx="3" fill="#d1d5db" stroke="#8b5c2e" stroke-width="1.2"/>
        <rect x="24" y="42" width="16" height="7" rx="2.5" fill="#fbbf24" stroke="#b45309" stroke-width="1.2"/>
        <rect x="30.5" y="48" width="3" height="9" rx="1.5" fill="#7c3aed"/>
        <ellipse cx="32" cy="54.5" rx="7" ry="3" fill="#7c3aed" opacity="0.25"/>
      </g>
    </svg>
    <h1>@PELEA DE SEGUIDORES</h1>
    <!-- SVG Espada Derecha -->
    <svg class="sword right" viewBox="0 0 64 64">
      <g>
        <rect x="29" y="6" width="6" height="38" rx="3" fill="#d1d5db" stroke="#8b5c2e" stroke-width="1.2"/>
        <rect x="24" y="42" width="16" height="7" rx="2.5" fill="#fbbf24" stroke="#b45309" stroke-width="1.2"/>
        <rect x="30.5" y="48" width="3" height="9" rx="1.5" fill="#7c3aed"/>
        <ellipse cx="32" cy="54.5" rx="7" ry="3" fill="#7c3aed" opacity="0.25"/>
      </g>
    </svg>
  </div>
  <div class="counter">Total de jugadores: <span id="total">0</span></div>
  <div class="card">
    <form id="form">
      <input id="nombre" type="text" placeholder="Usuario de Instagram (ej: @usuario)" required autocomplete="off" autocapitalize="off"/>
      <input id="foto" type="file" accept="image/*" required />
      <button id="btn" type="submit">Registrar</button>
      <div id="msg" class="msg"></div>
    </form>
  </div>
</div>
<script>
const API_URL = "https://peleadeseguidores-game-web.onrender.com/api/avatar";
const GITHUB_IMAGES_API = "https://api.github.com/repos/peleadeseguidores/peleadeseguidores-game-web/contents/images";
const totalEl = document.querySelector("#total");
const form = document.querySelector("#form");
const btn = document.querySelector("#btn");
const msg = document.querySelector("#msg");

async function toBase64(file){
  return new Promise((resolve,reject)=>{
    const reader=new FileReader();
    reader.onload=()=>{const [prefix,b64]=reader.result.split(",");resolve({base64:b64,mime:prefix.split(":")[1].split(";")[0]})};
    reader.onerror=()=>reject(reader.error);
    reader.readAsDataURL(file);
  });
}

// Contador real: cuenta los archivos en /images del repo
async function loadJugadores(){
  msg.style.color = "#374151";
  try{
    const res=await fetch(GITHUB_IMAGES_API);
    if (!res.ok) throw new Error("No se pudo conectar al repo.");
    const files = await res.json();
    // Cuenta solo imágenes válidas (.png, .jpg, .jpeg)
    const total = files.filter(f=>/\.png$|\.jpg$|\.jpeg$/i.test(f.name)).length;
    totalEl.textContent = total;
  }catch(e){
    msg.textContent="No se pudo cargar la lista.";
    msg.style.color = "#b91c1c";
    console.error(e);
  }
}

form.addEventListener("submit", async e=>{
  e.preventDefault();
  msg.textContent="";
  msg.style.color = "#374151";
  const nombre=document.querySelector("#nombre").value.trim();
  const file=document.querySelector("#foto").files[0];
  if(!nombre||!file){msg.textContent="Completa nombre y foto."; msg.style.color="#b91c1c"; return;}
  if(file.size>8*1024*1024){msg.textContent="La imagen debe pesar menos de 8 MB."; msg.style.color="#b91c1c"; return;}
  btn.disabled=true; btn.textContent="Enviando…";
  try{
    const {base64,mime}=await toBase64(file);
    // Envía al backend Python
    const res=await fetch(API_URL,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({nombre, base64, mimetype: mime})
    });
    const out=await res.json();
    if(res.ok){
      msg.style.color="#16a34a";msg.textContent="Jugador registrado con éxito.";
      form.reset();
      await loadJugadores();
    } else {
      throw new Error(out.error||"Error desconocido");
    }
  }catch(err){
    console.error(err);
    msg.style.color="#b91c1c";
    msg.textContent="Error al registrar: "+err.message;
  } finally{
    btn.disabled=false;btn.textContent="Registrar";
  }
});
loadJugadores();
</script>
</body>
</html>
